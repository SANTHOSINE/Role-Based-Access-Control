import hashlib
import datetime
import getpass  # hidden password input

# ---------------- DATABASE ----------------
users = {}
logs = []

# ---------------- PASSWORD HASHING ----------------
def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

# ---------------- REGISTER USER ----------------
def register_user():
    print("\nğŸ“ Register New User")
    username = input("ğŸ‘¤ Enter username: ").strip()
    if username in users:
        print("âš ï¸ User already exists. Try logging in.")
        return
    password = getpass.getpass("ğŸ”‘ Enter password: ").strip()
    role = input("ğŸ­ Enter role (admin/auditor/user): ").strip().lower()
    if role not in ["admin", "auditor", "user"]:
        print("âš ï¸ Invalid role! Defaulting to 'user'.")
        role = "user"
    users[username] = {"password": hash_password(password), "role": role}
    logs.append(f"[{datetime.datetime.now()}] {username} registered as {role}.")
    print(f"âœ… User '{username}' registered successfully as '{role}'!")

# ---------------- LOGIN USER ----------------
def login_user():
    print("\nğŸ” User Login")
    username = input("ğŸ‘¤ Username: ").strip()
    if username not in users:
        print("âŒ No such user found! Register first.")
        return None
    password = getpass.getpass("ğŸ”‘ Enter password: ").strip()
    if users[username]["password"] == hash_password(password):
        print(f"âœ… Login successful! Welcome back, {username} ({users[username]['role']}) âœ¨")
        logs.append(f"[{datetime.datetime.now()}] {username} logged in successfully.")
        return username
    else:
        print("ğŸš« Incorrect password! Access denied.")
        return None

# ---------------- ACCESS CONTROL ----------------
def access_resource(username):
    print("\nğŸ“‚ Access Resources")
    role = users[username]["role"]
    print(f"ğŸªª You are logged in as: {role.upper()}")
    print("Resources available: ğŸ”¹ read_data ğŸ”¹ delete_data ğŸ”¹ view_logs")
    resource = input("Enter resource to access: ").strip()

    if role == "admin":
        print(f"ğŸ”“ Admin '{username}' has full access to '{resource}' âœ…")
    elif role == "auditor" and resource in ["view_logs", "read_data"]:
        print(f"ğŸ“Š Auditor '{username}' can view '{resource}' ğŸ•µï¸â€â™‚ï¸")
    elif role == "user" and resource == "read_data":
        print(f"ğŸ“— User '{username}' can read data âœ…")
    else:
        print(f"ğŸš« Access denied! '{username}' cannot access '{resource}'.")
    logs.append(f"[{datetime.datetime.now()}] {username} tried to access '{resource}' as '{role}'.")

# ---------------- VIEW LOGS ----------------
def show_logs():
    print("\nğŸ“œ Activity Logs (Transparency Report):")
    if not logs:
        print("No logs available yet.")
    for log in logs:
        print(log)

# ---------------- MAIN MENU ----------------
def main_menu():
    print("\nğŸŒ Role Based Access Control")
    print("ğŸ•Šï¸ Supporting SDG 16: Peace, Justice, and Strong Institutions")
    print("---------------------------------------------------------------")

    while True:
        print("\nğŸ“‹ Menu:")
        print("1ï¸âƒ£ Register User")
        print("2ï¸âƒ£ Login")
        print("3ï¸âƒ£ View Logs (Admin only)")
        print("4ï¸âƒ£ Exit")

        choice = input("\nğŸ‘‰ Enter your choice (1-4): ").strip()

        if choice == "1":
            register_user()
        elif choice == "2":
            user = login_user()
            if user:
                access_resource(user)
        elif choice == "3":
            admin_name = input("ğŸ‘¤ Enter admin username: ").strip()
            if admin_name in users and users[admin_name]["role"] == "admin":
                show_logs()
            else:
                print("ğŸš« Only admins can view system logs!")
        elif choice == "4":
            print("\nğŸ‘‹ Thank you for using the IAM System! Stay secure ğŸ”’")
            break
        else:
            print("âš ï¸ Invalid choice! Try again.")

# ---------------- RUN PROGRAM ----------------
if __name__ == "__main__":
    main_menu()
